# Next.js 14 — Azure App Service Linux deployment
# Builds the Next.js app in CI, packages the compiled output,
# and deploys to the existing Azure Linux Web App.

trigger:
  - master

variables:
  # Azure Resource Manager service connection
  azureSubscription: "42c92c33-7c68-4d7d-8448-9d384a2f2b4c"

  # Target Azure App Service name
  webAppName: "personal-website-fe"

  # Deployment environment name (matches Azure DevOps environment)
  environmentName: "personal-website-fe"

  # Node.js version — must match App Service runtime below
  nodeVersion: "20.x"

  vmImageName: "ubuntu-latest"

stages:
  - stage: Build
    displayName: Build
    jobs:
      - job: Build
        displayName: Build Next.js app
        pool:
          vmImage: $(vmImageName)

        steps:
          - task: NodeTool@0
            displayName: "Use Node.js $(nodeVersion)"
            inputs:
              versionSpec: $(nodeVersion)

          - script: npm ci
            displayName: "Install dependencies"

          - script: npm run build
            displayName: "Build Next.js (next build)"

          # Remove dev dependencies before packaging to reduce artifact size
          - script: npm prune --production
            displayName: "Prune dev dependencies"

          - task: ArchiveFiles@2
            displayName: "Archive build output"
            inputs:
              rootFolderOrFile: "$(System.DefaultWorkingDirectory)"
              includeRootFolder: false
              archiveType: zip
              archiveFile: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip"
              replaceExistingArchive: true

          - upload: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip"
            artifact: drop

  - stage: Deploy
    displayName: Deploy
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: Deploy
        displayName: Deploy to Azure App Service
        environment: $(environmentName)
        pool:
          vmImage: $(vmImageName)
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureRmWebAppDeployment@4
                  displayName: "Azure App Service Deploy: $(webAppName)"
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appType: webAppLinux
                    WebAppName: $(webAppName)
                    packageForLinux: "$(Pipeline.Workspace)/drop/$(Build.BuildId).zip"
                    RuntimeStack: "NODE|20-lts"
                    StartupCommand: "npm run start"
